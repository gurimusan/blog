<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Gentoo on gurimusan blog</title>
    <link>https://gurimusan.github.io/blog/tags/gentoo/index.xml</link>
    <description>Recent content in Gentoo on gurimusan blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <atom:link href="https://gurimusan.github.io/blog/tags/gentoo/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Gentoo Linux をインストールする</title>
      <link>https://gurimusan.github.io/blog/post/gentoo-install-battle/</link>
      <pubDate>Wed, 08 Mar 2017 23:52:56 +0900</pubDate>
      
      <guid>https://gurimusan.github.io/blog/post/gentoo-install-battle/</guid>
      <description>

&lt;h1 id=&#34;gentoo-linux-をインストールする&#34;&gt;Gentoo Linux をインストールする&lt;/h1&gt;

&lt;h2 id=&#34;概要&#34;&gt;概要&lt;/h2&gt;

&lt;p&gt;転職し、新しい会社に入社した。&lt;/p&gt;

&lt;p&gt;PCを支給してくれるいうことで、macにしようかなと思っていたのだが、折角なのでdockerをまともに使える環境が良いなと思い、linuxベースの開発環境を作ることにした。&lt;/p&gt;

&lt;p&gt;そんな折、&lt;a href=&#34;http://d.hatena.ne.jp/joker1007/20161125/1480069437&#34;&gt;MacBook Proを捨ててThinkpad T460sを買ってgentooを入れた&lt;/a&gt;という記事をはてブで見つけて、gentooベースにすることにした。&lt;/p&gt;

&lt;p&gt;PCはノートパソコンで英語配列のものを考え、thinkpadかvaioにしようかと思ったが、thinkpad t460sにした。&lt;/p&gt;

&lt;p&gt;t460sには、もともとwindowsがインストールされているが、その上にGentoo Linux をインストールして、デュアルブート環境にする。&lt;/p&gt;

&lt;h2 id=&#34;gentoo歴&#34;&gt;Gentoo歴&lt;/h2&gt;

&lt;p&gt;6〜7年ほど前、家で1年ほど開発機として使っていた。その後、mac book買ったため、現在まで使っていない。&lt;/p&gt;

&lt;h2 id=&#34;thinkpad-t460s&#34;&gt;Thinkpad T460S&lt;/h2&gt;

&lt;p&gt;マシンスペック。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CPU i7 6600U&lt;/li&gt;
&lt;li&gt;HDD NVMe対応SSD 512GB&lt;/li&gt;
&lt;li&gt;メモリ 24G&lt;/li&gt;
&lt;li&gt;液晶 14型 WQHD 2560×1440&lt;/li&gt;
&lt;li&gt;キーボード 英語配列&lt;/li&gt;
&lt;li&gt;OS Windows 10 Home&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;インストールメディアの作成&#34;&gt;インストールメディアの作成&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.gentoo.org/downloads/&#34;&gt;ダウンロードページ&lt;/a&gt;からLiveDVDをダンロードして、mac上でUSBにddして焼いた。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ diskutil unmountDisk /dev/disk2
$ dd if=/Users/gurimusan/Downloads/livedvd-amd64-multilib-20160704.iso of=/dev/disk2 bs=1m
$ diskutil eject /dev/disk2
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;インストール前にやること&#34;&gt;インストール前にやること&lt;/h2&gt;

&lt;h3 id=&#34;uefi-のセキュアブートを切る&#34;&gt;UEFI のセキュアブートを切る&lt;/h3&gt;

&lt;p&gt;UEFIを操作してセキュアブートを切る。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://wiki.archlinuxjp.org/index.php/Windows_%E3%81%A8_Arch_%E3%81%AE%E3%83%87%E3%83%A5%E3%82%A2%E3%83%AB%E3%83%96%E3%83%BC%E3%83%88#UEFI_Secure_Boot&#34;&gt;Windows と Arch のデュアルブート&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;高速スタートアップを無効化する&#34;&gt;高速スタートアップを無効化する&lt;/h3&gt;

&lt;p&gt;&amp;ldquo;コントロールパネル&amp;rdquo;→&amp;rdquo;ハードウェアとサウンド&amp;rdquo;→&amp;rdquo;電源オプション&amp;rdquo;→&amp;rdquo;カバーを閉じたときの動作を選択&amp;rdquo;から無効化する。&lt;/p&gt;

&lt;h3 id=&#34;windows上でハードディスクのパーティションを分ける&#34;&gt;Windows上でハードディスクのパーティションを分ける。&lt;/h3&gt;

&lt;p&gt;gentooをインストールする領域を確保するために、Cドライブが割り当てられているパーティションを縮小して領域を確保する。&lt;/p&gt;

&lt;p&gt;Cドライブ上のデータを壊さなければ、windows上でやらなくても良い。&lt;/p&gt;

&lt;h2 id=&#34;gentoo-linuxのインストール&#34;&gt;Gentoo Linuxのインストール&lt;/h2&gt;

&lt;p&gt;作成したインストールメディアを起動して、Gentoo Linux をインストールする。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://wiki.gentoo.org/wiki/Handbook:AMD64/ja&#34;&gt;ハンドブック:AMD64 - Gentoo Wiki&lt;/a&gt; を見ながらインストールを行う。&lt;/p&gt;

&lt;h3 id=&#34;ディスクの準備&#34;&gt;ディスクの準備&lt;/h3&gt;

&lt;p&gt;パーティション構成は下記のとおり。&lt;/p&gt;

&lt;p&gt;前述のとおり、winのCドライブにあたるパーティションを縮小して、Gentoo Linux をインストールした領域を確保した。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;nvme0n1       477G
├─nvme0n1p1   260M      -- EFI
├─nvme0n1p2    16M      -- winの管理系？
├─nvme0n1p3  68.6G      -- win本体、Cドライブ
├─nvme0n1p4  1000M      -- winのリカバリ領域
├─nvme0n1p5    64G      -- / (ルート)
└─nvme0n1p6 343.1G      -- /home (home)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;新しい領域は&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;/&lt;/li&gt;
&lt;li&gt;/home&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;の2つに分けた。&lt;/p&gt;

&lt;p&gt;ファイルシステムをxfsを利用する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mkfs.xfs /dev/nvme0n1p5
$ mkfs.xfs /dev/nvme0n1p6
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;フォーマットしたパーティションをマウントする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mount /dev/nvme0n1p5 /mnt/gentoo
$ mkdir /mnt/gentoo/home /mnt/gentoo/boot
$ mount /dev/nvme0n1p6 /mnt/gentoo/home
$ mount /dev/nvme0n1p1 /mnt/gentoo/boot
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;gentooインストールファイルをインストール&#34;&gt;Gentooインストールファイルをインストール&lt;/h3&gt;

&lt;p&gt;時刻を合わせる。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ntpd -q -g
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Gentooミラーリストからstage tarballを取得する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cd /mnt/gentoo
$ links https://www.gentoo.org/downloads/mirrors/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;stage tarballを展開する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ tar xvjpf stage3-*.tar.bz2 --xattrs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/mnt/gentoo/etc/portage/make.conf を編集してGentooコンパイルオプションを設定する。&lt;/p&gt;

&lt;p&gt;CFLAGにはマシンアーキテクチャ（-march）と、最適化レベル（-O）を設定する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CFLAGS=&amp;quot;-march=broadwell -mtune=broadwell -O2 -pipe&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;-marchに skylakeの指定をするとコンパイル時にエラーとなった。&lt;/p&gt;

&lt;p&gt;調べたところ、&lt;a href=&#34;https://wiki.gentoo.org/wiki/Safe_CFLAGS#Skylake&#34;&gt;Safe CFLAGS - Gentoo Wiki&lt;/a&gt; にskylakeの設定例があったため、broadwellに変更した。&lt;/p&gt;

&lt;p&gt;MAKEOPTSでどれだけ並列してコンパイルを実施するか設定する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;MAKEOPTS=&amp;quot;-j4&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;CPU_FLAGS_X86 でCPUの命令セットの指定を行う。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CPU_FLAGS_X86=&amp;quot;aes avx avx2 fma3 mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3&amp;quot;

L10N=&amp;quot;ja en&amp;quot;
LINGUS=&amp;quot;ja en&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;gentooベースシステムのインストール&#34;&gt;Gentooベースシステムのインストール&lt;/h3&gt;

&lt;p&gt;ミラーサーバを設定しておく。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mirrorselect -i -o &amp;gt;&amp;gt; /mnt/gentoo/etc/portage/make.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;dnsのコピー&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cp -L /etc/resolv.conf /mnt/gentoo/etc/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;必要なファイルシステムをマウントする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mount -t proc proc /mnt/gentoo/proc
$ mount --rbind /sys /mnt/gentoo/sys
$ mount --make-rslave /mnt/gentoo/sys
$ mount --rbind /dev /mnt/gentoo/dev
$ mount --make-rslave /mnt/gentoo/dev
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;chrootする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ chroot /mnt/gentoo /bin/bash
$ source /etc/profile
$ export PS1=&#39;(chroot) $PS1&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Portageのリポジトリを更新する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ emerge-webrsync
$ emerge --sync
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;systemdが含んだプロファイルを選択する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ eselect profile list
Available profile symlink targets:
  [1]   default/linux/amd64/13.0
  [2]   default/linux/amd64/13.0/selinux
  [3]   default/linux/amd64/13.0/desktop
  [4]   default/linux/amd64/13.0/desktop/gnome
  [5]   default/linux/amd64/13.0/desktop/gnome/systemd
  [6]   default/linux/amd64/13.0/desktop/plasma
  [7]   default/linux/amd64/13.0/desktop/plasma/systemd
  [8]   default/linux/amd64/13.0/developer
  [9]   default/linux/amd64/13.0/no-multilib
  [10]  default/linux/amd64/13.0/systemd *
  [11]  default/linux/amd64/13.0/x32
  [12]  hardened/linux/amd64
  [13]  hardened/linux/amd64/selinux
  [14]  hardened/linux/amd64/no-multilib
  [15]  hardened/linux/amd64/no-multilib/selinux
  [16]  hardened/linux/amd64/x32
  [17]  hardened/linux/musl/amd64
  [18]  hardened/linux/musl/amd64/x32
  [19]  default/linux/uclibc/amd64
  [20]  hardened/linux/uclibc/amd64

$ eselect profile set 10
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/etc/portage/make.confのUSEフラグにsystemdを追加する。&lt;/p&gt;

&lt;p&gt;systemd向けにパッケージを更新する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ emerge -auDN @world
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;vim入れる。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ emerge -a app-editors/vim
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;タイムゾーンを設定する&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ echo &#39;Asia/Tyokyo&#39; &amp;gt; /etc/timezone
$ emerge --config sys-libs/timezone-data
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ロケールを設定する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ vim /etc/locale.gen
en_US ISO-8859-1
en_US.UTF-8 UTF-8
ja_JP.EUC-JP EUC-JP
ja_JP.UTF-8 UTF-8
ja_JP.SHIFT_JIS SHIFT_JIS

$ locale-gen

$ eselect locale list
Available targets for the LANG variable:
  [1]   C
  [2]   en_US
  [3]   en_US.iso88591
  [4]   en_US.utf8 *
  [5]   ja_JP
  [6]   ja_JP.eucjp
  [7]   ja_JP.shiftjis
  [8]   ja_JP.ujis
  [9]   ja_JP.utf8
  [10]  japanese
  [11]  japanese.euc
  [12]  POSIX
  [ ]   (free form)

$ eselect locale set 4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;環境設定の再読み込み。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ env-update
$ source /etc/profile
$ export PS1=&amp;quot;(chroot) $PS1&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;カーネルの設定&#34;&gt;カーネルの設定&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ emerge -a sys-kernel/gentoo-sources
$ emerge -a sys-apps/pciutils
$ cd /usr/src/linux
$ make menuconfig
$ make &amp;amp;&amp;amp; make modules_install
$ make install
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;システムの設定&#34;&gt;システムの設定&lt;/h3&gt;

&lt;p&gt;fstabの設定。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cat /etc/fstab
PARTUUID=5ce260de-80a3-4984-a4ea-758e917e3501       /boot           vfat    noauto,noatime                  1   2
PARTUUID=d193f1a5-edec-4c52-bbd0-5aa43de8f3be       /           xfs noatime                     0   1
PARTUUID=acabd133-51ed-4b85-bbb2-b5add70bef5f       /home           xfs noatime                     0   2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;grubはnvme未対応のため、利用できない。&lt;/p&gt;

&lt;p&gt;なので、systemd-bootを利用する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ bootctl --path=/boot install

$ vim /boot/loader/loader.conf
default gentoo
timeout 5
editor  0

$ vim /boot/loader/entries/gentoo.conf
title   Gentoo Linux
linux   /EFI/gentoo/vmlinuz-4.9.6-gentoo-r1
options root=PARTUUID=d193f1a5-edec-4c52-bbd0-5aa43de8f3be init=/usr/lib/systemd/systemd rw noefi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;カーネルイメージの配置。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mkdir /boot/EFI/gentoo
$ cp /boot/vmlinuz-4.9.6-gentoo-r1 /boot/EFI/gentoo/.
$ cp /boot/System.map-4.9.6-gentoo-r1 /boot/EFI/gentoo/.
$ cp /boot/config-4.9.6-gentoo-r1 /boot/EFI/gentoo/.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rebootして起動できればOK。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ exit
$ cd
$ umount -R /mnt/gentoo
$ shutdown -h now
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;インストール後の感想&#34;&gt;インストール後の感想&lt;/h2&gt;

&lt;p&gt;今のところ満足。やっぱり動作が軽快なのが良い。&lt;/p&gt;

&lt;p&gt;日本語入力の候補がウィンドウの左下に出てくること以外は。。。&lt;/p&gt;

&lt;h2 id=&#34;インストールしたもの&#34;&gt;インストールしたもの&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;awesome&lt;/li&gt;
&lt;li&gt;rxvt-unicode&lt;/li&gt;
&lt;li&gt;slim&lt;/li&gt;
&lt;li&gt;zsh&lt;/li&gt;
&lt;li&gt;git&lt;/li&gt;
&lt;li&gt;chromium&lt;/li&gt;
&lt;li&gt;firefox&lt;/li&gt;
&lt;li&gt;neovim&lt;/li&gt;
&lt;li&gt;ranger&lt;/li&gt;
&lt;li&gt;spacefm&lt;/li&gt;
&lt;li&gt;feh&lt;/li&gt;
&lt;li&gt;fcitx&lt;/li&gt;
&lt;li&gt;mozc&lt;/li&gt;
&lt;li&gt;scrot&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
  </channel>
</rss>